<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Importar Excel de Evolcampus - IZETA Admin</title>
    <!-- CSS del Dashboard -->
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/modern-dashboard.css">
    <link rel="stylesheet" href="css/dashboard-fixes.css">
    
    <!-- Scripts necesarios -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/js/env-config.js"></script>
    <script src="../assets/js/config.js"></script>
    <style>
        .excel-import-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .upload-zone {
            border: 3px dashed #0066cc;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #f0f7ff;
            margin: 20px 0;
            transition: all 0.3s ease;
        }
        
        .upload-zone.dragover {
            background: #e1f0ff;
            border-color: #0052cc;
        }
        
        .file-list {
            margin-top: 30px;
        }
        
        .file-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .file-item.processing {
            background: #fff3cd;
            border-color: #ffc107;
        }
        
        .file-item.completed {
            background: #d4edda;
            border-color: #28a745;
        }
        
        .file-item.error {
            background: #f8d7da;
            border-color: #dc3545;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-pending { background: #e0e0e0; color: #666; }
        .status-processing { background: #ffc107; color: #000; }
        .status-completed { background: #28a745; color: white; }
        .status-error { background: #dc3545; color: white; }
        
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .history-table th,
        .history-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .history-table th {
            background: #f5f5f5;
            font-weight: bold;
        }
        
        .upload-button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin: 20px 0;
        }
        
        .upload-button:hover {
            background: #0052cc;
        }
        
        .upload-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .info-box {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .info-box h3 {
            margin-top: 0;
            color: #0066cc;
        }
    </style>
</head>
<body>
    <!-- Header principal con el mismo estilo del dashboard -->
    <header class="main-header">
        <div class="header-left">
            <h1 class="page-title">üì• Importar Excel de Evolcampus</h1>
            <nav class="breadcrumb">
                <a href="dashboard.html">Dashboard</a>
                <span>/</span>
                <span>Importar Excel</span>
            </nav>
        </div>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="window.location.href='dashboard.html'">
                ‚Üê Volver
            </button>
            <button class="btn btn-secondary" onclick="logout()">
                üö™ Cerrar Sesi√≥n
            </button>
        </div>
    </header>

    <div class="content-wrapper">
        <div class="excel-import-container">
        <h2>Importar Informes Excel de Evolcampus</h2>
        
        <div class="info-box">
            <h3>üìã Instrucciones</h3>
            <ol>
                <li>Descarga los informes individuales de cada alumno desde Evolcampus (Informes ‚Üí Alumno)</li>
                <li>Arrastra los archivos Excel (.xlsx) a la zona de carga o haz clic para seleccionarlos</li>
                <li>Los archivos se procesar√°n autom√°ticamente</li>
                <li>Una vez procesados, los datos aparecer√°n en el dashboard principal</li>
            </ol>
            <p><strong>Formato esperado del nombre:</strong> expediente-nombre-apellidos-email.xlsx</p>
        </div>

        <div class="upload-zone" id="uploadZone">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" style="margin: 0 auto;">
                <path d="M7 10L12 5L17 10" stroke="#0066cc" stroke-width="2" stroke-linecap="round"/>
                <path d="M12 5V15" stroke="#0066cc" stroke-width="2" stroke-linecap="round"/>
                <path d="M20 16V20C20 20.5523 19.5523 21 19 21H5C4.44772 21 4 20.5523 4 20V16" stroke="#0066cc" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <h3>Arrastra archivos Excel aqu√≠</h3>
            <p>o haz clic para seleccionar</p>
            <input type="file" id="fileInput" multiple accept=".xlsx,.xls" style="display: none;">
        </div>

        <button class="upload-button" id="uploadBtn" disabled>Subir archivos seleccionados</button>

        <div class="file-list" id="fileList"></div>

        <h3 style="margin-top: 40px;">üìä Historial de Importaciones</h3>
        <table class="history-table" id="historyTable">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Archivo</th>
                    <th>Estudiante</th>
                    <th>Registros</th>
                    <th>Estado</th>
                    <th>Mensaje</th>
                </tr>
            </thead>
            <tbody id="historyBody">
                <tr>
                    <td colspan="6" style="text-align: center;">Cargando historial...</td>
                </tr>
            </tbody>
        </table>
    </div>
    </div> <!-- Cerrar content-wrapper -->

    <script>
        // Variables globales
        let supabaseClient;
        let selectedFiles = [];
        
        // Esperar a que las configuraciones est√©n cargadas
        document.addEventListener('DOMContentLoaded', async () => {
            // Usar la configuraci√≥n global de config.js
            const { createClient } = supabase;
            supabaseClient = createClient(window.supabaseUrl, window.supabaseAnonKey);
            
            // Elementos del DOM
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');
            const fileList = document.getElementById('fileList');
            const uploadBtn = document.getElementById('uploadBtn');

            // Verificar autenticaci√≥n y permisos de admin
            async function checkAuth() {
                try {
                    const { data: { user } } = await supabaseClient.auth.getUser();
                    if (!user) {
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    // Verificar si es admin
                    const { data: profile, error } = await supabaseClient
                        .from('users')
                        .select('is_admin')
                        .eq('id', user.id)
                        .single();
                    
                    if (error || !profile || profile.is_admin !== true) {
                        alert('No tienes permisos para acceder a esta secci√≥n');
                        window.location.href = 'dashboard.html';
                        return;
                    }
                    
                    console.log('‚úÖ Usuario admin verificado');
                } catch (error) {
                    console.error('Error verificando auth:', error);
                    window.location.href = 'login.html';
                }
            }

            // Drag and drop
            uploadZone.addEventListener('click', () => fileInput.click());
            
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });
            
            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
            });
            
            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });
            
            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });

            function handleFiles(files) {
                selectedFiles = Array.from(files).filter(file => 
                    file.name.endsWith('.xlsx') || file.name.endsWith('.xls')
                );
                
                displaySelectedFiles();
                uploadBtn.disabled = selectedFiles.length === 0;
            }

            function displaySelectedFiles() {
                fileList.innerHTML = '<h3>üìÅ Archivos seleccionados:</h3>';
                
                selectedFiles.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `
                        <div>
                            <strong>${file.name}</strong>
                            <span style="color: #666; margin-left: 10px;">${(file.size / 1024).toFixed(2)} KB</span>
                        </div>
                        <button onclick="removeFile(${index})" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                            Eliminar
                        </button>
                    `;
                    fileList.appendChild(fileItem);
                });
            }

            uploadBtn.addEventListener('click', async () => {
                if (selectedFiles.length === 0) return;
                
                uploadBtn.disabled = true;
                uploadBtn.textContent = 'Subiendo archivos...';
                
                for (const file of selectedFiles) {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item processing';
                    fileItem.innerHTML = `
                        <div>
                            <strong>${file.name}</strong>
                            <span class="status-badge status-processing">Procesando...</span>
                        </div>
                    `;
                    fileList.appendChild(fileItem);
                    
                    try {
                        // Subir archivo al bucket
                        const { data, error } = await supabaseClient.storage
                            .from('evol-excel-import')
                            .upload(file.name, file, {
                                cacheControl: '3600',
                                upsert: true
                            });
                        
                        if (error) throw error;
                        
                        // Actualizar UI
                        fileItem.className = 'file-item completed';
                        fileItem.innerHTML = `
                            <div>
                                <strong>${file.name}</strong>
                                <span class="status-badge status-completed">‚úì Subido</span>
                            </div>
                        `;
                        
                        // El procesamiento se har√° autom√°ticamente por el trigger
                        console.log(`Archivo ${file.name} subido exitosamente`);
                        
                    } catch (error) {
                        console.error('Error subiendo archivo:', error);
                        fileItem.className = 'file-item error';
                        fileItem.innerHTML = `
                            <div>
                                <strong>${file.name}</strong>
                                <span class="status-badge status-error">‚úó Error: ${error.message}</span>
                            </div>
                        `;
                    }
                }
                
                // Limpiar selecci√≥n
                selectedFiles = [];
                fileInput.value = '';
                uploadBtn.textContent = 'Subir archivos seleccionados';
                uploadBtn.disabled = true;
                
                // Actualizar historial
                setTimeout(loadHistory, 2000);
            });

            // Cargar historial
            async function loadHistory() {
                try {
                    const { data, error } = await supabaseClient
                        .from('excel_import_history')
                        .select('*')
                        .order('created_at', { ascending: false })
                        .limit(20);
                    
                    if (error) throw error;
                    
                    const historyBody = document.getElementById('historyBody');
                    
                    if (!data || data.length === 0) {
                        historyBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No hay importaciones previas</td></tr>';
                        return;
                    }
                    
                    historyBody.innerHTML = data.map(record => {
                        const date = new Date(record.created_at).toLocaleString('es-ES');
                        const statusClass = `status-${record.status}`;
                        const statusText = {
                            pending: 'Pendiente',
                            processing: 'Procesando',
                            completed: 'Completado',
                            error: 'Error'
                        }[record.status] || record.status;
                        
                        return `
                            <tr>
                                <td>${date}</td>
                                <td>${record.file_name}</td>
                                <td>${record.student_email || '-'}</td>
                                <td>${record.records_imported || 0}</td>
                                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                                <td>${record.error_message || '-'}</td>
                            </tr>
                        `;
                    }).join('');
                    
                } catch (error) {
                    console.error('Error cargando historial:', error);
                }
            }

            // Inicializar
            checkAuth();
            loadHistory();
            
            // Actualizar historial cada 10 segundos
            setInterval(loadHistory, 10000);
            
            // Hacer funciones accesibles globalmente
            window.displaySelectedFiles = displaySelectedFiles;
        }); // Cerrar DOMContentLoaded
        
        // Funciones globales que necesitan estar fuera del DOMContentLoaded
        window.removeFile = function(index) {
            selectedFiles.splice(index, 1);
            window.displaySelectedFiles();
            document.getElementById('uploadBtn').disabled = selectedFiles.length === 0;
        };

        // Funci√≥n de logout
        window.logout = async function() {
            if (supabaseClient) {
                await supabaseClient.auth.signOut();
            }
            window.location.href = 'login.html';
        };
    </script>
</body>
</html> 
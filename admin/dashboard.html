<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Administrativo - IZETA 2025</title>
    <style>
        :root {
            /* Sistema de colores coherente con el proyecto */
            --primary: #1E3A8A;
            --primary-dark: #0E2A6A;
            --secondary: #111827;
            --accent-gold: #FBBF24;
            --accent-purple: #9b59b6;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #DC2626;
            --info: #3B82F6;
            
            --bg-light: #F9FAFB;
            --bg-dark: #1F2937;
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --border-color: #E5E7EB;
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-light);
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        /* Layout principal con sidebar mejorado */
        .dashboard-layout {
            display: grid;
            grid-template-columns: 260px 1fr;
            min-height: 100vh;
        }
        
        /* Sidebar mejorado */
        .sidebar {
            background: var(--bg-dark);
            color: white;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            transition: all 0.3s ease;
        }
        
        .sidebar-header {
            padding: 1.5rem;
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .sidebar-user {
            font-size: 0.875rem;
            opacity: 0.8;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .nav-section {
            padding: 1rem 0;
        }
        
        .nav-section-title {
            padding: 0.5rem 1.5rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            opacity: 0.6;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1.5rem;
            color: white;
            text-decoration: none;
            transition: all 0.2s;
            position: relative;
        }
        
        .nav-item:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .nav-item.active {
            background: var(--primary);
        }
        
        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--accent-gold);
        }
        
        .nav-icon {
            width: 20px;
            text-align: center;
        }
        
        .nav-badge {
            margin-left: auto;
            background: var(--danger);
            color: white;
            font-size: 0.75rem;
            padding: 0.125rem 0.5rem;
            border-radius: 10px;
        }
        
        /* Contenido principal */
        .main-content {
            padding: 0;
            background: var(--bg-light);
            overflow-x: hidden;
        }
        
        /* Header mejorado */
        .main-header {
            background: white;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
            flex-wrap: wrap;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
        }
        
        .page-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        /* Sistema de filtros mejorado */
        .filters-bar {
            background: white;
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .filter-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        /* Contenedor de contenido */
        .content-wrapper {
            padding: 2rem;
        }
        
        /* Grid de estad√≠sticas mejorado */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }
        
        .stat-card.primary::before { background: var(--primary); }
        .stat-card.success::before { background: var(--success); }
        .stat-card.warning::before { background: var(--warning); }
        .stat-card.danger::before { background: var(--danger); }
        
        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .stat-icon.primary { background: rgba(30, 58, 138, 0.1); color: var(--primary); }
        .stat-icon.success { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .stat-icon.warning { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .stat-icon.danger { background: rgba(220, 38, 38, 0.1); color: var(--danger); }
        
        .stat-content {
            flex: 1;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        
        .stat-change {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.875rem;
        }
        
        .change-positive { color: var(--success); }
        .change-negative { color: var(--danger); }
        
        .stat-chart {
            margin-top: 1rem;
            height: 60px;
        }
        
        /* Gr√°ficos mejorados */
        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .chart-card {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        
        .chart-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .chart-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .chart-body {
            padding: 1.5rem;
        }
        
        /* Tablas mejoradas */
        .table-card {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 2rem;
        }
        
        .table-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .table-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .table-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .search-box {
            position: relative;
        }
        
        .search-input {
            padding: 0.5rem 1rem 0.5rem 2.5rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 300px;
            transition: all 0.2s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }
        
        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }
        
        /* Tabla responsive mejorada */
        .table-wrapper {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: var(--bg-light);
        }
        
        th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            white-space: nowrap;
        }
        
        td {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
        }
        
        tr:hover {
            background: rgba(30, 58, 138, 0.02);
        }
        
        /* Sistema de badges mejorado */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .badge-primary { background: rgba(30, 58, 138, 0.1); color: var(--primary); }
        .badge-success { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .badge-warning { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .badge-danger { background: rgba(220, 38, 38, 0.1); color: var(--danger); }
        .badge-info { background: rgba(59, 130, 246, 0.1); color: var(--info); }
        
        /* Botones mejorados */
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }
        
        .btn-secondary {
            background: white;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            background: var(--bg-light);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.8125rem;
        }
        
        .btn-icon {
            padding: 0.5rem;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 6px;
        }
        
        .btn-icon:hover {
            background: var(--bg-light);
            color: var(--text-primary);
        }
        
        /* Indicadores de riesgo */
        .risk-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        .risk-critical { color: var(--danger); }
        .risk-high { color: #ef4444; }
        .risk-medium { color: var(--warning); }
        .risk-low { color: var(--success); }
        
        /* Modal mejorado */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }
        
        .modal.active {
            display: flex;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow: hidden;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .modal-body {
            padding: 1.5rem;
            max-height: calc(90vh - 200px);
            overflow-y: auto;
        }
        
        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }
        
        /* Tabs mejorados */
        .tabs {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 2rem;
        }
        
        .tab {
            padding: 0.75rem 1.5rem;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s;
            position: relative;
        }
        
        .tab:hover {
            color: var(--text-primary);
        }
        
        .tab.active {
            color: var(--primary);
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary);
        }
        
        /* Timeline */
        .timeline {
            position: relative;
            padding-left: 2rem;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border-color);
        }
        
        .timeline-item {
            position: relative;
            padding-bottom: 1.5rem;
        }
        
        .timeline-marker {
            position: absolute;
            left: -2.5rem;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: white;
            border: 2px solid var(--primary);
        }
        
        /* Tooltips */
        [data-tooltip] {
            position: relative;
            cursor: help;
        }
        
        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-dark);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 10;
            margin-bottom: 0.5rem;
        }
        
        /* Loading states */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Progress bars */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s ease;
        }
        
        /* Notificaciones */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 1rem;
            max-width: 400px;
            animation: slideInRight 0.3s ease;
            z-index: 1000;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        
        .notification.success .notification-icon {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .notification.error .notification-icon {
            background: rgba(220, 38, 38, 0.1);
            color: var(--danger);
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .dashboard-layout {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: fixed;
                left: -260px;
                z-index: 100;
                transition: left 0.3s ease;
            }
            
            .sidebar.open {
                left: 0;
            }
            
            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 99;
            }
            
            .sidebar-overlay.show {
                display: block;
            }
            
            .mobile-menu-toggle {
                display: flex;
            }
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .search-input {
                width: 100%;
            }
        }
        
        /* Utility classes */
        .text-muted { color: var(--text-secondary); }
        .text-small { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        
        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-3 { margin-top: 0.75rem; }
        .mt-4 { margin-top: 1rem; }
        
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        
        .hidden { display: none; }
        
        /* Spinner mejorado */
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Mobile menu toggle (hidden by default) */
        .mobile-menu-toggle {
            display: none;
            padding: 0.5rem;
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--text-primary);
        }
    </style>
</head>
<body>
    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <span>‚ôî</span>
                    <span>IZETA 2025</span>
                </div>
                <div class="sidebar-user">
                    <span>üë§</span>
                    <span id="currentUserEmail">admin@izeta.com</span>
                </div>
            </div>
            
            <nav class="nav-section">
                <div class="nav-section-title">PRINCIPAL</div>
                <a href="#overview" class="nav-item active" data-page="overview">
                    <span class="nav-icon">üìä</span>
                    <span>Vista General</span>
                </a>
                <a href="#analytics" class="nav-item" data-page="analytics">
                    <span class="nav-icon">üìà</span>
                    <span>Analytics Avanzado</span>
                </a>
                <a href="#students" class="nav-item" data-page="students">
                    <span class="nav-icon">üë•</span>
                    <span>Gesti√≥n de Alumnos</span>
                    <span class="nav-badge" id="totalStudentsBadge">0</span>
                </a>
                <a href="#at-risk" class="nav-item" data-page="at-risk">
                    <span class="nav-icon">‚ö†Ô∏è</span>
                    <span>Alumnos en Riesgo</span>
                    <span class="nav-badge" id="atRiskBadge">0</span>
                </a>
            </nav>
            
            <nav class="nav-section">
                <div class="nav-section-title">COMUNICACI√ìN</div>
                <a href="#emails" class="nav-item" data-page="emails">
                    <span class="nav-icon">üìß</span>
                    <span>Gesti√≥n de Emails</span>
                </a>
                <a href="#alerts" class="nav-item" data-page="alerts">
                    <span class="nav-icon">üîî</span>
                    <span>Alertas Autom√°ticas</span>
                </a>
            </nav>
            
            <nav class="nav-section">
                <div class="nav-section-title">CONFIGURACI√ìN</div>
                <a href="#simulations" class="nav-item" data-page="simulations">
                    <span class="nav-icon">üéØ</span>
                    <span>Simulacros</span>
                </a>
                <a href="#reports" class="nav-item" data-page="reports">
                    <span class="nav-icon">üìä</span>
                    <span>Informes</span>
                </a>
                <a href="#settings" class="nav-item" data-page="settings">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span>Configuraci√≥n</span>
                </a>
            </nav>
            
            <nav class="nav-section" style="margin-top: auto; padding-bottom: 2rem;">
                <a href="#" class="nav-item" onclick="logout()">
                    <span class="nav-icon">üö™</span>
                    <span>Cerrar Sesi√≥n</span>
                </a>
            </nav>
        </aside>
        
        <!-- Overlay para m√≥vil -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
        
        <!-- Contenido principal -->
        <main class="main-content">
            <!-- Header principal -->
            <header class="main-header">
                <div class="header-left">
                    <button class="mobile-menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
                    <h1 class="page-title" id="pageTitle">Vista General</h1>
                    <nav class="breadcrumb">
                        <span>Dashboard</span>
                        <span>/</span>
                        <span id="breadcrumbCurrent">Vista General</span>
                    </nav>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="refreshData()">
                        üîÑ Actualizar
                    </button>
                    <button class="btn btn-primary" onclick="showExportModal()">
                        üì• Exportar Datos
                    </button>
                </div>
            </header>
            
            <!-- Barra de filtros -->
            <div class="filters-bar" id="filtersBar">
                <div class="filter-group">
                    <label class="filter-label">Periodo:</label>
                    <select id="periodFilter" class="btn btn-secondary" onchange="applyFilters()">
                        <option value="week">Esta semana</option>
                        <option value="month">Este mes</option>
                        <option value="all">Todo</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Cohorte:</label>
                    <select id="cohortFilter" class="btn btn-secondary" onchange="applyFilters()">
                        <option value="all">Todas</option>
                        <option value="20h">20h - Base</option>
                        <option value="36h">36h - Intensivo</option>
                        <option value="48h">48h - √âlite</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Nivel de riesgo:</label>
                    <select id="riskFilter" class="btn btn-secondary" onchange="applyFilters()">
                        <option value="all">Todos</option>
                        <option value="critical">Cr√≠tico</option>
                        <option value="high">Alto</option>
                        <option value="medium">Medio</option>
                        <option value="low">Bajo</option>
                    </select>
                </div>
            </div>
            
            <!-- Contenido din√°mico -->
            <div class="content-wrapper" id="contentWrapper">
                <!-- El contenido se cargar√° din√°micamente -->
            </div>
        </main>
    </div>
    
    <!-- Modal de Email -->
    <div class="modal" id="emailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Enviar Email</h2>
                <button class="btn btn-icon" onclick="hideModal('emailModal')">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group mb-4">
                    <label class="form-label">Destinatarios</label>
                    <select id="emailRecipients" class="form-control">
                        <option value="all">Todos los alumnos</option>
                        <option value="at-risk">Solo alumnos en riesgo</option>
                        <option value="cohort-20h">Cohorte 20h</option>
                        <option value="cohort-36h">Cohorte 36h</option>
                        <option value="cohort-48h">Cohorte 48h</option>
                        <option value="custom">Selecci√≥n personalizada...</option>
                    </select>
                </div>
                
                <div class="form-group mb-4">
                    <label class="form-label">Plantilla de Email</label>
                    <select id="emailTemplate" class="form-control" onchange="updateEmailPreview()">
                        <option value="weekly_report">Informe Semanal Est√°ndar</option>
                        <option value="performance_alert">Alerta de Bajo Rendimiento</option>
                        <option value="improvement_congrats">Felicitaci√≥n por Mejora</option>
                        <option value="simulation_reminder">Recordatorio de Simulacro</option>
                        <option value="custom">Mensaje Personalizado</option>
                    </select>
                </div>
                
                <div class="form-group mb-4">
                    <label class="form-label">Asunto</label>
                    <input type="text" id="emailSubject" class="form-control" 
                           value="üìä Tu progreso semanal - IZETA 2025">
                </div>
                
                <div class="form-group mb-4">
                    <label class="form-label">Vista previa del mensaje</label>
                    <div id="emailPreview" style="background: #f8f9fa; padding: 1rem; border-radius: 8px; min-height: 200px;">
                        <!-- Vista previa se actualizar√° din√°micamente -->
                    </div>
                </div>
                
                <div class="form-group mb-4">
                    <label class="form-label">Mensaje adicional (opcional)</label>
                    <textarea id="emailAdditionalMessage" class="form-control" rows="3"
                              placeholder="Este mensaje se a√±adir√° al email est√°ndar..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('emailModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="sendEmails()">
                    üìß Enviar Emails
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Exportaci√≥n -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Exportar Datos</h2>
                <button class="btn btn-icon" onclick="hideModal('exportModal')">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group mb-4">
                    <label class="form-label">Tipo de datos</label>
                    <select id="exportType" class="form-control">
                        <option value="students">Lista de estudiantes</option>
                        <option value="results">Resultados de simulacros</option>
                        <option value="analytics">An√°lisis completo</option>
                        <option value="at-risk">Informe de alumnos en riesgo</option>
                    </select>
                </div>
                
                <div class="form-group mb-4">
                    <label class="form-label">Formato</label>
                    <div style="display: flex; gap: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="radio" name="exportFormat" value="csv" checked>
                            <span>CSV</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="radio" name="exportFormat" value="excel">
                            <span>Excel</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="radio" name="exportFormat" value="pdf">
                            <span>PDF</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group mb-4">
                    <label class="form-label">Filtros aplicados</label>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                        <p id="exportFiltersPreview">Se exportar√°n todos los datos seg√∫n los filtros actuales</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('exportModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="exportData()">
                    üì• Descargar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Detalles de Estudiante -->
    <div class="modal" id="studentDetailModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">Detalles del Estudiante</h2>
                <button class="btn btn-icon" onclick="hideModal('studentDetailModal')">‚úï</button>
            </div>
            <div class="modal-body" id="studentDetailContent">
                <!-- Contenido din√°mico -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('studentDetailModal')">Cerrar</button>
                <button class="btn btn-primary" onclick="editStudent()">
                    ‚úèÔ∏è Editar
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/assets/js/config.js"></script>
    <script>
        // Variables globales del dashboard
        let currentUser = null;
        let currentPage = 'overview';
        let dashboardData = {
            students: [],
            results: [],
            simulations: [],
            cohortStats: [],
            atRiskStudents: [],
            emailQueue: []
        };
        let chartInstances = {};
        let filters = {
            period: 'week',
            cohort: 'all',
            risk: 'all'
        };

        // Inicializaci√≥n del dashboard
        async function initDashboard() {
            try {
                // Verificar autenticaci√≥n
                const user = await checkAuth();
                if (!user) {
                    window.location.href = '/admin/login.html';
                    return;
                }

                // Verificar permisos de admin
                const isAdminUser = await isAdmin();
                if (!isAdminUser) {
                    showNotification('error', 'No tienes permisos de administrador');
                    window.location.href = '/public/index.html';
                    return;
                }

                currentUser = user;
                document.getElementById('currentUserEmail').textContent = user.email;

                // Cargar datos iniciales
                await loadDashboardData();

                // Configurar navegaci√≥n
                setupNavigation();

                // Mostrar p√°gina inicial
                showPage('overview');

                // Configurar actualizaci√≥n autom√°tica
                setInterval(updateRealTimeMetrics, 30000); // Cada 30 segundos

            } catch (error) {
                console.error('Error iniciando dashboard:', error);
                showNotification('error', 'Error al cargar el dashboard');
            }
        }

        // Cargar todos los datos del dashboard
        async function loadDashboardData() {
            showLoading(true);
            
            try {
                // Cargar datos en paralelo para mejor rendimiento
                const [
                    students,
                    cohortStats,
                    atRiskData,
                    activeSimulation,
                    recentResults,
                    emailQueueData
                ] = await Promise.all([
                    // Todos los estudiantes
                    supabaseClient
                        .from('users')
                        .select('*')
                        .order('created_at', { ascending: false }),
                    
                    // Estad√≠sticas por cohorte
                    supabaseClient
                        .from('cohort_statistics')
                        .select('*'),
                    
                    // Estudiantes en riesgo con detalles
                    supabaseClient
                        .from('admin_dashboard')
                        .select('*')
                        .in('risk_level', ['high', 'critical'])
                        .order('probability_pass', { ascending: true }),
                    
                    // Simulacro activo
                    supabaseClient
                        .from('weekly_simulations')
                        .select('*')
                        .eq('status', 'active')
                        .single(),
                    
                    // Resultados recientes
                    supabaseClient
                        .from('user_results')
                        .select(`
                            *,
                            users!inner(slug, username, email, cohort),
                            weekly_simulations!inner(week_number)
                        `)
                        .order('submitted_at', { ascending: false })
                        .limit(100),
                    
                    // Cola de emails
                    supabaseClient
                        .from('email_queue')
                        .select('*')
                        .eq('status', 'pending')
                ]);

                // Procesar y almacenar datos
                dashboardData = {
                    students: students.data || [],
                    cohortStats: cohortStats.data || [],
                    atRiskStudents: atRiskData.data || [],
                    activeSimulation: activeSimulation.data,
                    recentResults: recentResults.data || [],
                    emailQueue: emailQueueData.data || []
                };

                // Actualizar badges
                updateBadges();

                showLoading(false);
                
            } catch (error) {
                console.error('Error cargando datos:', error);
                showNotification('error', 'Error al cargar los datos del dashboard');
                showLoading(false);
            }
        }

        // Configurar navegaci√≥n entre p√°ginas
        function setupNavigation() {
            document.querySelectorAll('.nav-item[data-page]').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = item.dataset.page;
                    showPage(page);
                    
                    // Actualizar estado activo
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    item.classList.add('active');
                });
            });
        }

        // Mostrar p√°gina espec√≠fica
        function showPage(page) {
            currentPage = page;
            const contentWrapper = document.getElementById('contentWrapper');
            
            // Actualizar t√≠tulo y breadcrumb
            const titles = {
                'overview': 'Vista General',
                'analytics': 'Analytics Avanzado',
                'students': 'Gesti√≥n de Alumnos',
                'at-risk': 'Alumnos en Riesgo',
                'emails': 'Gesti√≥n de Emails',
                'alerts': 'Alertas Autom√°ticas',
                'simulations': 'Gesti√≥n de Simulacros',
                'reports': 'Informes',
                'settings': 'Configuraci√≥n'
            };
            
            document.getElementById('pageTitle').textContent = titles[page];
            document.getElementById('breadcrumbCurrent').textContent = titles[page];
            
            // Mostrar/ocultar filtros seg√∫n la p√°gina
            document.getElementById('filtersBar').style.display = 
                ['overview', 'analytics', 'students', 'at-risk'].includes(page) ? 'flex' : 'none';
            
            // Cargar contenido de la p√°gina
            switch(page) {
                case 'overview':
                    renderOverviewPage();
                    break;
                case 'analytics':
                    renderAnalyticsPage();
                    break;
                case 'students':
                    renderStudentsPage();
                    break;
                case 'at-risk':
                    renderAtRiskPage();
                    break;
                case 'emails':
                    renderEmailsPage();
                    break;
                case 'alerts':
                    renderAlertsPage();
                    break;
                case 'simulations':
                    renderSimulationsPage();
                    break;
                case 'reports':
                    renderReportsPage();
                    break;
                case 'settings':
                    renderSettingsPage();
                    break;
            }
        }

        // Renderizar p√°gina de vista general
        function renderOverviewPage() {
            const filteredData = applyDataFilters(dashboardData);
            
            const html = `
                <!-- Estad√≠sticas principales -->
                <div class="stats-grid">
                    <div class="stat-card primary">
                        <div class="stat-header">
                            <div class="stat-icon primary">üë•</div>
                            <div class="stat-content">
                                <div class="stat-label">Total Estudiantes</div>
                                <div class="stat-value">${filteredData.students.length}</div>
                                <div class="stat-change change-positive">
                                    <span>‚Üë</span> ${getNewStudentsCount()} nuevos esta semana
                                </div>
                            </div>
                        </div>
                        <div class="stat-chart">
                            <canvas id="studentsSparkline"></canvas>
                        </div>
                    </div>
                    
                    <div class="stat-card success">
                        <div class="stat-header">
                            <div class="stat-icon success">üìà</div>
                            <div class="stat-content">
                                <div class="stat-label">Probabilidad Media de Aprobar</div>
                                <div class="stat-value">${calculateAverageProbability(filteredData.students)}%</div>
                                <div class="stat-change ${getProbabilityTrend() > 0 ? 'change-positive' : 'change-negative'}">
                                    <span>${getProbabilityTrend() > 0 ? '‚Üë' : '‚Üì'}</span> 
                                    ${Math.abs(getProbabilityTrend())}% vs semana anterior
                                </div>
                            </div>
                        </div>
                        <div class="stat-chart">
                            <canvas id="probabilitySparkline"></canvas>
                        </div>
                    </div>
                    
                    <div class="stat-card warning">
                        <div class="stat-header">
                            <div class="stat-icon warning">‚ö†Ô∏è</div>
                            <div class="stat-content">
                                <div class="stat-label">Estudiantes en Riesgo</div>
                                <div class="stat-value">${filteredData.atRiskStudents.length}</div>
                                <div class="stat-change change-negative">
                                    <span>‚Üë</span> +${getNewAtRiskCount()} vs semana anterior
                                </div>
                            </div>
                        </div>
                        <div class="stat-chart">
                            <canvas id="riskSparkline"></canvas>
                        </div>
                    </div>
                    
                    <div class="stat-card danger">
                        <div class="stat-header">
                            <div class="stat-icon danger">üìâ</div>
                            <div class="stat-content">
                                <div class="stat-label">Tasa de Abandono</div>
                                <div class="stat-value">${calculateDropoutRate()}%</div>
                                <div class="stat-change">
                                    <span>‚Üí</span> Sin cambios
                                </div>
                            </div>
                        </div>
                        <div class="stat-chart">
                            <canvas id="dropoutSparkline"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Gr√°ficos principales -->
                <div class="charts-section">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Distribuci√≥n por Probabilidad de Aprobar</h3>
                            <div class="chart-actions">
                                <button class="btn btn-sm btn-secondary" onclick="updateChart('probability')">
                                    üîÑ
                                </button>
                            </div>
                        </div>
                        <div class="chart-body">
                            <canvas id="probabilityDistributionChart" height="300"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Rendimiento por Cohorte</h3>
                            <div class="chart-actions">
                                <button class="btn btn-sm btn-secondary" onclick="updateChart('cohort')">
                                    üîÑ
                                </button>
                            </div>
                        </div>
                        <div class="chart-body">
                            <canvas id="cohortPerformanceChart" height="300"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Tabla de estudiantes en riesgo -->
                <div class="table-card">
                    <div class="table-header">
                        <h2 class="table-title">‚ö†Ô∏è Estudiantes que Requieren Atenci√≥n Inmediata</h2>
                        <div class="table-controls">
                            <div class="search-box">
                                <span class="search-icon">üîç</span>
                                <input type="text" class="search-input" placeholder="Buscar estudiante..." 
                                       onkeyup="filterTable('atRiskTable', this.value)">
                            </div>
                            <button class="btn btn-primary" onclick="showEmailModal('at-risk')">
                                üìß Email a todos
                            </button>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table id="atRiskTable">
                            <thead>
                                <tr>
                                    <th>Estudiante</th>
                                    <th>Cohorte</th>
                                    <th>Score Promedio</th>
                                    <th>Z-Score</th>
                                    <th>P(Aprobar)</th>
                                    <th>Tendencia</th>
                                    <th>Riesgo</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${renderAtRiskStudentsRows(filteredData.atRiskStudents.slice(0, 10))}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Timeline de actividad reciente -->
                <div class="table-card">
                    <div class="table-header">
                        <h2 class="table-title">üìÖ Actividad Reciente</h2>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div class="timeline">
                            ${renderActivityTimeline()}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('contentWrapper').innerHTML = html;
            
            // Inicializar gr√°ficos
            setTimeout(() => {
                createSparklines();
                createMainCharts();
            }, 100);
        }

        // Renderizar p√°gina de analytics avanzado
        function renderAnalyticsPage() {
            const html = `
                <div class="tabs">
                    <button class="tab active" onclick="showAnalyticsTab('trends')">Tendencias</button>
                    <button class="tab" onclick="showAnalyticsTab('predictions')">Predicciones</button>
                    <button class="tab" onclick="showAnalyticsTab('cohorts')">An√°lisis por Cohortes</button>
                    <button class="tab" onclick="showAnalyticsTab('topics')">An√°lisis por Temas</button>
                </div>

                <div id="analyticsContent">
                    <!-- Contenido din√°mico seg√∫n tab -->
                </div>
            `;
            
            document.getElementById('contentWrapper').innerHTML = html;
            showAnalyticsTab('trends');
        }

        // Renderizar p√°gina de gesti√≥n de estudiantes
        function renderStudentsPage() {
            const filteredStudents = applyDataFilters(dashboardData).students;
            
            const html = `
                <div class="table-card">
                    <div class="table-header">
                        <h2 class="table-title">üìä Todos los Estudiantes (${filteredStudents.length})</h2>
                        <div class="table-controls">
                            <div class="search-box">
                                <span class="search-icon">üîç</span>
                                <input type="text" class="search-input" placeholder="Buscar por nombre, email o slug..." 
                                       onkeyup="filterTable('studentsTable', this.value)">
                            </div>
                            <button class="btn btn-secondary" onclick="showBulkActions()">
                                ‚ö° Acciones masivas
                            </button>
                            <button class="btn btn-primary" onclick="window.location.href='/admin/bulk-users.html'">
                                ‚ûï A√±adir alumnos
                            </button>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table id="studentsTable">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" onchange="toggleSelectAll(this)"></th>
                                    <th>Estudiante</th>
                                    <th>Email</th>
                                    <th>Slug</th>
                                    <th>Cohorte</th>
                                    <th>ELO</th>
                                    <th>Simulacros</th>
                                    <th>Promedio</th>
                                    <th>P(Aprobar)</th>
                                    <th>Racha</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${renderAllStudentsRows(filteredStudents)}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Acciones masivas (oculto por defecto) -->
                <div id="bulkActionsPanel" style="display: none;" class="table-card mt-4">
                    <div class="table-header">
                        <h3 class="table-title">‚ö° Acciones Masivas</h3>
                        <button class="btn btn-sm btn-secondary" onclick="hideBulkActions()">‚úï Cerrar</button>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div class="filter-group mb-3">
                            <label class="filter-label">Para los estudiantes seleccionados:</label>
                        </div>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="bulkChangeCohorte()">
                                üîÑ Cambiar cohorte
                            </button>
                            <button class="btn btn-success" onclick="bulkSendEmail()">
                                üìß Enviar email
                            </button>
                            <button class="btn btn-warning" onclick="bulkAddNote()">
                                üìù A√±adir nota
                            </button>
                            <button class="btn btn-danger" onclick="bulkDeactivate()">
                                ‚ùå Desactivar
                            </button>
                        </div>
                        <div class="mt-3">
                            <span class="text-muted">
                                <span id="selectedCount">0</span> estudiantes seleccionados
                            </span>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('contentWrapper').innerHTML = html;
        }

        // Renderizar p√°gina de estudiantes en riesgo
        function renderAtRiskPage() {
            const atRiskStudents = dashboardData.atRiskStudents;
            
            const html = `
                <div class="stats-grid mb-4">
                    <div class="stat-card danger">
                        <div class="stat-header">
                            <div class="stat-icon danger">üö®</div>
                            <div class="stat-content">
                                <div class="stat-label">Riesgo Cr√≠tico</div>
                                <div class="stat-value">${atRiskStudents.filter(s => s.risk_level === 'critical').length}</div>
                                <div class="text-muted text-small">P(Aprobar) < 30%</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card warning">
                        <div class="stat-header">
                            <div class="stat-icon warning">‚ö†Ô∏è</div>
                            <div class="stat-content">
                                <div class="stat-label">Riesgo Alto</div>
                                <div class="stat-value">${atRiskStudents.filter(s => s.risk_level === 'high').length}</div>
                                <div class="text-muted text-small">P(Aprobar) 30-50%</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card primary">
                        <div class="stat-header">
                            <div class="stat-icon primary">üìä</div>
                            <div class="stat-content">
                                <div class="stat-label">Z-Score Medio</div>
                                <div class="stat-value">${calculateAverageZScore(atRiskStudents)}</div>
                                <div class="text-muted text-small">Desviaci√≥n del grupo</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card info">
                        <div class="stat-header">
                            <div class="stat-icon primary">üìà</div>
                            <div class="stat-content">
                                <div class="stat-label">Mejorando</div>
                                <div class="stat-value">${atRiskStudents.filter(s => s.trend_direction === 'up').length}</div>
                                <div class="text-muted text-small">Tendencia positiva</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-card">
                    <div class="table-header">
                        <h2 class="table-title">üö® An√°lisis Detallado de Estudiantes en Riesgo</h2>
                        <div class="table-controls">
                            <button class="btn btn-danger" onclick="generateRiskReport()">
                                üìÑ Generar informe
                            </button>
                            <button class="btn btn-primary" onclick="showRiskInterventionModal()">
                                üéØ Plan de intervenci√≥n
                            </button>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table id="atRiskDetailTable">
                            <thead>
                                <tr>
                                    <th>Estudiante</th>
                                    <th>Diagn√≥stico</th>
                                    <th>M√©tricas Clave</th>
                                    <th>Factores de Riesgo</th>
                                    <th>Recomendaciones</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${renderDetailedAtRiskRows(atRiskStudents)}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            document.getElementById('contentWrapper').innerHTML = html;
        }

        // Funciones auxiliares para renderizar filas de tablas
        function renderAtRiskStudentsRows(students) {
            return students.map(student => {
                const riskClass = student.risk_level === 'critical' ? 'risk-critical' : 
                                 student.risk_level === 'high' ? 'risk-high' : 'risk-medium';
                const trendIcon = student.trend_direction === 'up' ? '‚Üó' : 
                                 student.trend_direction === 'down' ? '‚Üò' : '‚Üí';
                const trendClass = student.trend_direction === 'up' ? 'change-positive' : 
                                  student.trend_direction === 'down' ? 'change-negative' : '';
                
                return `
                    <tr>
                        <td>
                            <div>
                                <div class="font-semibold">${student.username}</div>
                                <div class="text-small text-muted">${student.email}</div>
                            </div>
                        </td>
                        <td>
                            <span class="badge badge-info">${student.cohort}</span>
                        </td>
                        <td>${student.average_score?.toFixed(1) || 'N/A'}/100</td>
                        <td>
                            <span style="color: ${student.z_score < 0 ? 'var(--danger)' : 'var(--success)'}">
                                ${student.z_score?.toFixed(2) || 'N/A'}
                            </span>
                        </td>
                        <td>
                            <div class="risk-indicator ${riskClass}">
                                <span>‚ö†Ô∏è</span> ${student.probability_pass?.toFixed(0) || 0}%
                            </div>
                        </td>
                        <td>
                            <span class="${trendClass}">
                                ${trendIcon} ${Math.abs(student.delta_z || 0).toFixed(2)}
                            </span>
                        </td>
                        <td>
                            ${getRiskBadges(student)}
                        </td>
                        <td>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-icon btn-sm" onclick="viewStudentDetails('${student.id}')" title="Ver detalles">
                                    üëÅÔ∏è
                                </button>
                                <button class="btn btn-icon btn-sm" onclick="sendPersonalEmail('${student.id}')" title="Enviar email">
                                    üìß
                                </button>
                                <button class="btn btn-icon btn-sm" onclick="addStudentNote('${student.id}')" title="A√±adir nota">
                                    üìù
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderAllStudentsRows(students) {
            return students.map(student => {
                const streakEmoji = student.current_streak >= 8 ? 'üî•' : '‚≠ê';
                const isActive = student.active ? '‚úÖ' : '‚ùå';
                
                return `
                    <tr>
                        <td>
                            <input type="checkbox" class="student-checkbox" value="${student.id}">
                        </td>
                        <td class="font-semibold">${student.username}</td>
                        <td class="text-small">${student.email}</td>
                        <td><code>${student.slug}</code></td>
                        <td>
                            <span class="badge badge-info">${student.cohort}</span>
                        </td>
                        <td class="font-semibold" style="color: var(--primary);">
                            ${student.current_elo}
                        </td>
                        <td>${student.total_simulations}</td>
                        <td>${student.average_score?.toFixed(1) || 'N/A'}</td>
                        <td>
                            <div class="risk-indicator ${getProbabilityClass(student.probability_pass)}">
                                ${student.probability_pass?.toFixed(0) || 0}%
                            </div>
                        </td>
                        <td>
                            ${student.current_streak > 0 ? 
                                `<span class="badge badge-danger">${streakEmoji} ${student.current_streak}</span>` : 
                                '-'}
                        </td>
                        <td>${isActive} ${student.active ? 'Activo' : 'Inactivo'}</td>
                        <td>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-icon btn-sm" onclick="viewStudentDetails('${student.id}')" title="Ver detalles">
                                    üëÅÔ∏è
                                </button>
                                <button class="btn btn-icon btn-sm" onclick="editStudent('${student.id}')" title="Editar">
                                    ‚úèÔ∏è
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderDetailedAtRiskRows(students) {
            return students.map(student => {
                const diagnosis = getStudentDiagnosis(student);
                const riskFactors = getRiskFactors(student);
                const recommendations = getRecommendations(student);
                
                return `
                    <tr>
                        <td>
                            <div>
                                <div class="font-semibold">${student.username}</div>
                                <div class="text-small text-muted">${student.email}</div>
                                <div class="text-xs text-muted mt-1">Slug: ${student.slug}</div>
                            </div>
                        </td>
                        <td>
                            <div class="badge badge-${diagnosis.severity}">
                                ${diagnosis.icon} ${diagnosis.text}
                            </div>
                            <div class="text-small text-muted mt-1">
                                √öltima actividad: ${formatDate(student.last_participation)}
                            </div>
                        </td>
                        <td>
                            <div class="text-small">
                                <div>üìä Score: ${student.average_score?.toFixed(1) || 'N/A'}</div>
                                <div>üìà Z-Score: ${student.z_score?.toFixed(2) || 'N/A'}</div>
                                <div>üéØ P(Aprobar): ${student.probability_pass?.toFixed(0)}%</div>
                                <div>üî• Racha: ${student.current_streak}</div>
                            </div>
                        </td>
                        <td>
                            <div class="text-small">
                                ${riskFactors.map(factor => 
                                    `<div class="mb-1">${factor.icon} ${factor.text}</div>`
                                ).join('')}
                            </div>
                        </td>
                        <td>
                            <div class="text-small">
                                ${recommendations.map(rec => 
                                    `<div class="mb-1">‚Ä¢ ${rec}</div>`
                                ).join('')}
                            </div>
                        </td>
                        <td>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <button class="btn btn-sm btn-primary" onclick="createIntervention('${student.id}')">
                                    üéØ Intervenci√≥n
                                </button>
                                <button class="btn btn-sm btn-success" onclick="scheduleFollowUp('${student.id}')">
                                    üìÖ Seguimiento
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Funciones de an√°lisis y c√°lculo
        function calculateAverageProbability(students) {
            if (!students.length) return 0;
            const sum = students.reduce((acc, s) => acc + (s.probability_pass || 50), 0);
            return (sum / students.length).toFixed(1);
        }

        function calculateDropoutRate() {
            const inactiveCount = dashboardData.students.filter(s => !s.active).length;
            const total = dashboardData.students.length;
            return total ? ((inactiveCount / total) * 100).toFixed(1) : 0;
        }

        function calculateAverageZScore(students) {
            if (!students.length) return 0;
            const sum = students.reduce((acc, s) => acc + (s.z_score || 0), 0);
            return (sum / students.length).toFixed(2);
        }

        function getNewStudentsCount() {
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            return dashboardData.students.filter(s => 
                new Date(s.created_at) > oneWeekAgo
            ).length;
        }

        function getNewAtRiskCount() {
            // Esto requerir√≠a hist√≥rico, por ahora simulamos
            return Math.floor(Math.random() * 5) + 1;
        }

        function getProbabilityTrend() {
            // Simulaci√≥n, en producci√≥n vendr√≠a de datos hist√≥ricos
            return (Math.random() * 4 - 2).toFixed(1);
        }

        function getRiskBadges(student) {
            const badges = [];
            
            if (student.probability_pass < 30) {
                badges.push('<span class="badge badge-danger">Prob. muy baja</span>');
            } else if (student.probability_pass < 50) {
                badges.push('<span class="badge badge-warning">Prob. baja</span>');
            }
            
            if (student.trend_direction === 'down') {
                badges.push('<span class="badge badge-warning">Tendencia ‚Üì</span>');
            }
            
            if (student.current_streak === 0) {
                badges.push('<span class="badge badge-danger">Racha rota</span>');
            }
            
            if (student.z_score < -1.5) {
                badges.push('<span class="badge badge-danger">Z-score cr√≠tico</span>');
            }
            
            return badges.join(' ');
        }

        function getProbabilityClass(probability) {
            if (probability >= 70) return 'risk-low';
            if (probability >= 50) return 'risk-medium';
            if (probability >= 30) return 'risk-high';
            return 'risk-critical';
        }

        function getStudentDiagnosis(student) {
            if (student.probability_pass < 30) {
                return { icon: 'üö®', text: 'Cr√≠tico', severity: 'danger' };
            } else if (student.probability_pass < 50) {
                return { icon: '‚ö†Ô∏è', text: 'Alto riesgo', severity: 'warning' };
            } else if (student.trend_direction === 'down') {
                return { icon: 'üìâ', text: 'En declive', severity: 'warning' };
            }
            return { icon: 'üìä', text: 'Monitorizar', severity: 'info' };
        }

        function getRiskFactors(student) {
            const factors = [];
            
            if (student.average_score < 70) {
                factors.push({ icon: 'üìä', text: 'Score bajo constante' });
            }
            
            if (student.current_streak === 0) {
                factors.push({ icon: 'üíî', text: 'Racha interrumpida' });
            }
            
            if (student.z_score < -1) {
                factors.push({ icon: 'üìâ', text: 'Muy por debajo de la media' });
            }
            
            if (student.total_simulations < 5) {
                factors.push({ icon: 'üéØ', text: 'Poca pr√°ctica' });
            }
            
            if (student.trend_direction === 'down') {
                factors.push({ icon: '‚¨áÔ∏è', text: 'Tendencia negativa' });
            }
            
            return factors;
        }

        function getRecommendations(student) {
            const recommendations = [];
            
            if (student.average_score < 70) {
                recommendations.push('Reforzar conceptos b√°sicos');
                recommendations.push('Sesiones de repaso adicionales');
            }
            
            if (student.current_streak === 0) {
                recommendations.push('Recuperar rutina de estudio');
                recommendations.push('Establecer horario fijo');
            }
            
            if (student.z_score < -1) {
                recommendations.push('Tutor√≠a personalizada');
                recommendations.push('Material de apoyo extra');
            }
            
            if (student.cohort === '20h' && student.probability_pass < 50) {
                recommendations.push('Considerar cambio a 36h');
            }
            
            return recommendations;
        }

        // Crear gr√°ficos sparkline
        function createSparklines() {
            // Destruir gr√°ficos existentes
            Object.keys(chartInstances).forEach(key => {
                if (key.includes('Sparkline') && chartInstances[key]) {
                    chartInstances[key].destroy();
                }
            });

            // Datos de ejemplo para sparklines (en producci√≥n vendr√≠an de la BD)
            const last7Days = Array.from({length: 7}, (_, i) => {
                const date = new Date();
                date.setDate(date.getDate() - (6 - i));
                return date.toLocaleDateString();
            });

            // Sparkline de estudiantes
            const studentsCtx = document.getElementById('studentsSparkline');
            if (studentsCtx) {
                chartInstances.studentsSparkline = new Chart(studentsCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: last7Days,
                        datasets: [{
                            data: [240, 241, 241, 243, 244, 245, 245],
                            borderColor: '#1E3A8A',
                            backgroundColor: 'rgba(30, 58, 138, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 0,
                            pointHoverRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: { enabled: false }
                        },
                        scales: {
                            x: { display: false },
                            y: { display: false }
                        }
                    }
                });
            }

            // Sparkline de probabilidad
            const probabilityCtx = document.getElementById('probabilitySparkline');
            if (probabilityCtx) {
                chartInstances.probabilitySparkline = new Chart(probabilityCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: last7Days,
                        datasets: [{
                            data: [66.2, 66.5, 67.1, 67.8, 68.0, 68.2, 68.4],
                            borderColor: '#10B981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 0,
                            pointHoverRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: { enabled: false }
                        },
                        scales: {
                            x: { display: false },
                            y: { display: false }
                        }
                    }
                });
            }

            // Sparkline de riesgo
            const riskCtx = document.getElementById('riskSparkline');
            if (riskCtx) {
                chartInstances.riskSparkline = new Chart(riskCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: last7Days,
                        datasets: [{
                            data: [32, 33, 34, 35, 36, 36, 37],
                            borderColor: '#F59E0B',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 0,
                            pointHoverRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: { enabled: false }
                        },
                        scales: {
                            x: { display: false },
                            y: { display: false }
                        }
                    }
                });
            }

            // Sparkline de abandono
            const dropoutCtx = document.getElementById('dropoutSparkline');
            if (dropoutCtx) {
                chartInstances.dropoutSparkline = new Chart(dropoutCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: last7Days,
                        datasets: [{
                            data: [3.2, 3.2, 3.2, 3.2, 3.2, 3.2, 3.2],
                            borderColor: '#DC2626',
                            backgroundColor: 'rgba(220, 38, 38, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 0,
                            pointHoverRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: { enabled: false }
                        },
                        scales: {
                            x: { display: false },
                            y: { display: false }
                        }
                    }
                });
            }
        }

        // Crear gr√°ficos principales
        function createMainCharts() {
            // Destruir gr√°ficos existentes
            if (chartInstances.probabilityDistribution) {
                chartInstances.probabilityDistribution.destroy();
            }
            if (chartInstances.cohortPerformance) {
                chartInstances.cohortPerformance.destroy();
            }

            // Gr√°fico de distribuci√≥n de probabilidad
            const probCtx = document.getElementById('probabilityDistributionChart');
            if (probCtx) {
                const students = dashboardData.students;
                const high = students.filter(s => s.probability_pass >= 70).length;
                const medium = students.filter(s => s.probability_pass >= 50 && s.probability_pass < 70).length;
                const low = students.filter(s => s.probability_pass < 50).length;

                chartInstances.probabilityDistribution = new Chart(probCtx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Alta (>70%)', 'Media (50-70%)', 'Baja (<50%)'],
                        datasets: [{
                            data: [high, medium, low],
                            backgroundColor: ['#10B981', '#F59E0B', '#DC2626'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    font: { size: 12 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                                        return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Gr√°fico de rendimiento por cohorte
            const cohortCtx = document.getElementById('cohortPerformanceChart');
            if (cohortCtx) {
                const cohortData = dashboardData.cohortStats;
                
                chartInstances.cohortPerformance = new Chart(cohortCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: cohortData.map(c => c.cohort),
                        datasets: [
                            {
                                label: 'Score Promedio',
                                data: cohortData.map(c => c.average_score || 0),
                                backgroundColor: '#3B82F6',
                                borderRadius: 8
                            },
                            {
                                label: 'Probabilidad de Aprobar',
                                data: cohortData.map(c => c.average_pass_probability || 0),
                                backgroundColor: '#10B981',
                                borderRadius: 8
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    font: { size: 12 }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Funciones de interacci√≥n
        function showEmailModal(recipients = 'all') {
            document.getElementById('emailRecipients').value = recipients;
            updateEmailPreview();
            showModal('emailModal');
        }

        function showExportModal() {
            updateExportPreview();
            showModal('exportModal');
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function updateEmailPreview() {
            const template = document.getElementById('emailTemplate').value;
            const preview = document.getElementById('emailPreview');
            
            // Plantillas de ejemplo
            const templates = {
                'weekly_report': `
                    <h3>Informe Semanal de Progreso</h3>
                    <p>Estimado/a [Nombre],</p>
                    <p>Te enviamos tu informe de progreso de esta semana:</p>
                    <ul>
                        <li>üìä Score promedio: [Score]</li>
                        <li>üìà Probabilidad de aprobar: [Probabilidad]%</li>
                        <li>üî• Racha actual: [Racha] semanas</li>
                    </ul>
                    <p>Sigue as√≠ y alcanzar√°s tus objetivos.</p>
                `,
                'performance_alert': `
                    <h3>‚ö†Ô∏è Alerta de Rendimiento</h3>
                    <p>Hola [Nombre],</p>
                    <p>Hemos detectado que tu rendimiento ha bajado en las √∫ltimas semanas.</p>
                    <p>Tu probabilidad actual de aprobar es del [Probabilidad]%, lo cual te sit√∫a en zona de riesgo.</p>
                    <p><strong>Te recomendamos:</strong></p>
                    <ul>
                        <li>Aumentar las horas de estudio semanales</li>
                        <li>Revisar los temas m√°s d√©biles</li>
                        <li>Contactar con tu tutor para apoyo adicional</li>
                    </ul>
                `,
                'improvement_congrats': `
                    <h3>üéâ ¬°Felicidades por tu Mejora!</h3>
                    <p>¬°Excelente trabajo, [Nombre]!</p>
                    <p>Has mejorado significativamente en las √∫ltimas semanas:</p>
                    <ul>
                        <li>‚úÖ Tu score ha aumentado en [Mejora] puntos</li>
                        <li>‚úÖ Tu probabilidad de aprobar ahora es del [Probabilidad]%</li>
                    </ul>
                    <p>¬°Sigue con este excelente ritmo!</p>
                `
            };
            
            preview.innerHTML = templates[template] || '<p>Selecciona una plantilla...</p>';
        }

        async function sendEmails() {
            const recipients = document.getElementById('emailRecipients').value;
            const template = document.getElementById('emailTemplate').value;
            const subject = document.getElementById('emailSubject').value;
            const additionalMessage = document.getElementById('emailAdditionalMessage').value;
            
            showLoading(true);
            
            try {
                // Determinar destinatarios
                let targetUsers = [];
                switch(recipients) {
                    case 'all':
                        targetUsers = dashboardData.students;
                        break;
                    case 'at-risk':
                        targetUsers = dashboardData.atRiskStudents;
                        break;
                    case 'cohort-20h':
                        targetUsers = dashboardData.students.filter(s => s.cohort === '20h');
                        break;
                    case 'cohort-36h':
                        targetUsers = dashboardData.students.filter(s => s.cohort === '36h');
                        break;
                    case 'cohort-48h':
                        targetUsers = dashboardData.students.filter(s => s.cohort === '48h');
                        break;
                }
                
                // Preparar emails para la cola
                const emailPromises = targetUsers.map(user => {
                    return supabaseClient
                        .from('email_queue')
                        .insert({
                            to_email: user.email,
                            subject: subject,
                            template_id: template,
                            template_data: {
                                username: user.username,
                                score: user.average_score,
                                probability: user.probability_pass,
                                streak: user.current_streak,
                                additional_message: additionalMessage
                            }
                        });
                });
                
                await Promise.all(emailPromises);
                
                showNotification('success', `${targetUsers.length} emails a√±adidos a la cola de env√≠o`);
                hideModal('emailModal');
                
            } catch (error) {
                console.error('Error enviando emails:', error);
                showNotification('error', 'Error al enviar los emails');
            } finally {
                showLoading(false);
            }
        }

        function updateExportPreview() {
            const filters = `
                ‚Ä¢ Periodo: ${document.getElementById('periodFilter').value}
                ‚Ä¢ Cohorte: ${document.getElementById('cohortFilter').value}
                ‚Ä¢ Nivel de riesgo: ${document.getElementById('riskFilter').value}
            `;
            document.getElementById('exportFiltersPreview').textContent = filters;
        }

        async function exportData() {
            const exportType = document.getElementById('exportType').value;
            const exportFormat = document.querySelector('input[name="exportFormat"]:checked').value;
            
            showLoading(true);
            
            try {
                let data = [];
                let filename = '';
                
                switch(exportType) {
                    case 'students':
                        data = dashboardData.students;
                        filename = 'estudiantes';
                        break;
                    case 'results':
                        data = dashboardData.recentResults;
                        filename = 'resultados';
                        break;
                    case 'analytics':
                        data = prepareAnalyticsExport();
                        filename = 'analytics';
                        break;
                    case 'at-risk':
                        data = dashboardData.atRiskStudents;
                        filename = 'estudiantes_riesgo';
                        break;
                }
                
                // Aplicar filtros
                data = applyDataFilters({ [exportType]: data })[exportType] || data;
                
                // Generar archivo seg√∫n formato
                if (exportFormat === 'csv') {
                    downloadCSV(data, `${filename}_${new Date().toISOString().split('T')[0]}.csv`);
                } else if (exportFormat === 'excel') {
                    // En producci√≥n, usar una librer√≠a como SheetJS
                    showNotification('info', 'Exportaci√≥n Excel no implementada en esta demo');
                } else if (exportFormat === 'pdf') {
                    // En producci√≥n, usar una librer√≠a como jsPDF
                    showNotification('info', 'Exportaci√≥n PDF no implementada en esta demo');
                }
                
                hideModal('exportModal');
                
            } catch (error) {
                console.error('Error exportando datos:', error);
                showNotification('error', 'Error al exportar los datos');
            } finally {
                showLoading(false);
            }
        }

        function downloadCSV(data, filename) {
            if (!data || data.length === 0) {
                showNotification('warning', 'No hay datos para exportar');
                return;
            }
            
            // Obtener headers
            const headers = Object.keys(data[0]);
            
            // Crear CSV
            let csv = headers.join(',') + '\n';
            
            data.forEach(row => {
                const values = headers.map(header => {
                    const value = row[header];
                    // Escapar comillas y manejar valores con comas
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                        return `"${value.replace(/"/g, '""')}"`;
                    }
                    return value || '';
                });
                csv += values.join(',') + '\n';
            });
            
            // Descargar
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            
            showNotification('success', 'Archivo descargado correctamente');
        }

        function prepareAnalyticsExport() {
            // Preparar datos agregados para exportaci√≥n
            return dashboardData.students.map(student => ({
                ...student,
                risk_level: student.probability_pass < 30 ? 'critical' : 
                           student.probability_pass < 50 ? 'high' : 
                           student.probability_pass < 70 ? 'medium' : 'low',
                last_simulation_score: dashboardData.recentResults
                    .find(r => r.user_id === student.id)?.score || 'N/A'
            }));
        }

        // Aplicar filtros a los datos
        function applyDataFilters(data) {
            let filtered = { ...data };
            
            // Filtro por periodo
            if (filters.period !== 'all') {
                const dateLimit = new Date();
                if (filters.period === 'week') {
                    dateLimit.setDate(dateLimit.getDate() - 7);
                } else if (filters.period === 'month') {
                    dateLimit.setMonth(dateLimit.getMonth() - 1);
                }
                
                // Aplicar filtro de fecha donde sea relevante
                if (filtered.students) {
                    filtered.students = filtered.students.filter(s => 
                        !s.last_participation || new Date(s.last_participation) > dateLimit
                    );
                }
            }
            
            // Filtro por cohorte
            if (filters.cohort !== 'all') {
                if (filtered.students) {
                    filtered.students = filtered.students.filter(s => s.cohort === filters.cohort);
                }
                if (filtered.atRiskStudents) {
                    filtered.atRiskStudents = filtered.atRiskStudents.filter(s => s.cohort === filters.cohort);
                }
            }
            
            // Filtro por nivel de riesgo
            if (filters.risk !== 'all') {
                if (filtered.students) {
                    filtered.students = filtered.students.filter(s => {
                        const level = s.probability_pass < 30 ? 'critical' : 
                                     s.probability_pass < 50 ? 'high' : 
                                     s.probability_pass < 70 ? 'medium' : 'low';
                        return level === filters.risk;
                    });
                }
                if (filtered.atRiskStudents) {
                    filtered.atRiskStudents = filtered.atRiskStudents.filter(s => 
                        s.risk_level === filters.risk
                    );
                }
            }
            
            return filtered;
        }

        // Funciones de utilidad
        function showNotification(type, message) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-icon ${type}">
                    ${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}
                </div>
                <div>
                    <div class="font-semibold">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                    <div class="text-small">${message}</div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function showLoading(show) {
            // En producci√≥n, mostrar un spinner global
            if (show) {
                console.log('Cargando...');
            } else {
                console.log('Carga completa');
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric' 
            });
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('es-ES').format(num);
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
        }

        function filterTable(tableId, searchTerm) {
            const table = document.getElementById(tableId);
            const rows = table.querySelectorAll('tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm.toLowerCase()) ? '' : 'none';
            });
        }

        function toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('.student-checkbox');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const selected = document.querySelectorAll('.student-checkbox:checked').length;
            document.getElementById('selectedCount').textContent = selected;
        }

        function showBulkActions() {
            document.getElementById('bulkActionsPanel').style.display = 'block';
        }

        function hideBulkActions() {
            document.getElementById('bulkActionsPanel').style.display = 'none';
        }

        async function refreshData() {
            showNotification('info', 'Actualizando datos...');
            await loadDashboardData();
            showPage(currentPage);
            showNotification('success', 'Datos actualizados');
        }

        function updateBadges() {
            document.getElementById('totalStudentsBadge').textContent = dashboardData.students.length;
            document.getElementById('atRiskBadge').textContent = dashboardData.atRiskStudents.length;
        }

        function applyFilters() {
            filters.period = document.getElementById('periodFilter').value;
            filters.cohort = document.getElementById('cohortFilter').value;
            filters.risk = document.getElementById('riskFilter').value;
            
            showPage(currentPage);
        }

        async function logout() {
            if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
                await supabaseClient.auth.signOut();
                window.location.href = '/admin/login.html';
            }
        }

        // Funciones placeholder para acciones de estudiantes
        async function viewStudentDetails(studentId) {
            const student = dashboardData.students.find(s => s.id === studentId) || 
                           dashboardData.atRiskStudents.find(s => s.id === studentId);
            
            if (!student) return;
            
            const content = `
                <div style="display: grid; gap: 1.5rem;">
                    <div>
                        <h3>${student.username}</h3>
                        <p class="text-muted">${student.email}</p>
                        <p class="text-small">Slug: <code>${student.slug}</code></p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                        <div class="stat-card">
                            <div class="stat-label">Cohorte</div>
                            <div class="stat-value text-small">${student.cohort}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">ELO Actual</div>
                            <div class="stat-value text-small">${student.current_elo}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Promedio</div>
                            <div class="stat-value text-small">${student.average_score?.toFixed(1) || 'N/A'}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">P(Aprobar)</div>
                            <div class="stat-value text-small">${student.probability_pass?.toFixed(0)}%</div>
                        </div>
                    </div>
                    
                    <div>
                        <h4>Historial de Simulacros</h4>
                        <div class="table-wrapper">
                            <table style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Simulacro</th>
                                        <th>Score</th>
                                        <th>Posici√≥n</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${dashboardData.recentResults
                                        .filter(r => r.user_id === studentId)
                                        .slice(0, 5)
                                        .map(r => `
                                            <tr>
                                                <td>${formatDate(r.submitted_at)}</td>
                                                <td>RF${r.weekly_simulations.week_number}</td>
                                                <td>${r.score}/100</td>
                                                <td>${r.position || 'N/A'}</td>
                                            </tr>
                                        `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('studentDetailContent').innerHTML = content;
            showModal('studentDetailModal');
        }

        function editStudent(studentId) {
            // Implementar edici√≥n
            showNotification('info', 'Funci√≥n de edici√≥n en desarrollo');
        }

        function sendPersonalEmail(studentId) {
            // Implementar email personal
            showEmailModal();
        }

        function addStudentNote(studentId) {
            const note = prompt('A√±adir nota para el estudiante:');
            if (note) {
                showNotification('success', 'Nota a√±adida correctamente');
            }
        }

        function createIntervention(studentId) {
            // Implementar creaci√≥n de intervenci√≥n
            showNotification('info', 'Creando plan de intervenci√≥n...');
        }

        function scheduleFollowUp(studentId) {
            // Implementar programaci√≥n de seguimiento
            showNotification('info', 'Programando seguimiento...');
        }

        function generateRiskReport() {
            // Generar informe de riesgo
            showNotification('info', 'Generando informe de estudiantes en riesgo...');
        }

        function showRiskInterventionModal() {
            // Mostrar modal de intervenci√≥n
            showNotification('info', 'Abriendo plan de intervenci√≥n...');
        }

        // Timeline de actividad
        function renderActivityTimeline() {
            const activities = [
                { time: 'Hace 5 min', text: 'Mar√≠a Garc√≠a envi√≥ resultados del simulacro RF15', type: 'success' },
                { time: 'Hace 23 min', text: 'Carlos L√≥pez mejor√≥ su probabilidad al 75%', type: 'info' },
                { time: 'Hace 1 hora', text: 'Se detectaron 3 nuevos estudiantes en riesgo', type: 'warning' },
                { time: 'Hace 2 horas', text: '15 emails enviados autom√°ticamente', type: 'info' },
                { time: 'Hace 3 horas', text: 'Juan P√©rez rompi√≥ su racha de 8 semanas', type: 'danger' }
            ];
            
            return activities.map(activity => `
                <div class="timeline-item">
                    <div class="timeline-marker"></div>
                    <div>
                        <div class="text-small text-muted">${activity.time}</div>
                        <div>${activity.text}</div>
                    </div>
                </div>
            `).join('');
        }

        // Tabs de analytics
        function showAnalyticsTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            const content = document.getElementById('analyticsContent');
            
            switch(tab) {
                case 'trends':
                    content.innerHTML = renderTrendsTab();
                    break;
                case 'predictions':
                    content.innerHTML = renderPredictionsTab();
                    break;
                case 'cohorts':
                    content.innerHTML = renderCohortsTab();
                    break;
                case 'topics':
                    content.innerHTML = renderTopicsTab();
                    break;
            }
        }

        function renderTrendsTab() {
            return `
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Evoluci√≥n del Rendimiento General</h3>
                    </div>
                    <div class="chart-body">
                        <canvas id="trendsChart" height="400"></canvas>
                    </div>
                </div>
            `;
        }

        function renderPredictionsTab() {
            return `
                <div class="table-card">
                    <div class="table-header">
                        <h3 class="table-title">üîÆ Predicciones de Aprobaci√≥n</h3>
                    </div>
                    <div style="padding: 1.5rem;">
                        <p>An√°lisis predictivo basado en tendencias actuales...</p>
                    </div>
                </div>
            `;
        }

        function renderCohortsTab() {
            return `
                <div class="stats-grid">
                    ${dashboardData.cohortStats.map(cohort => `
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-content">
                                    <div class="stat-label">Cohorte ${cohort.cohort}</div>
                                    <div class="stat-value">${cohort.total_students} estudiantes</div>
                                    <div class="text-small mt-2">
                                        <div>Score medio: ${cohort.average_score?.toFixed(1) || 'N/A'}</div>
                                        <div>P(Aprobar): ${cohort.average_pass_probability?.toFixed(1) || 'N/A'}%</div>
                                        <div>En riesgo: ${cohort.at_risk_count}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderTopicsTab() {
            return `
                <div class="table-card">
                    <div class="table-header">
                        <h3 class="table-title">üìö An√°lisis por Temas D√©biles</h3>
                    </div>
                    <div style="padding: 1.5rem;">
                        <p>An√°lisis de los temas m√°s problem√°ticos...</p>
                    </div>
                </div>
            `;
        }

        // Inicializar dashboard
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>
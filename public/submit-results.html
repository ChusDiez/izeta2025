<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IZETA 2025 - Enviar Resultados</title>
    <style>
        :root {
            --primary: #1E3A8A;
            --primary-dark: #0E2A6A;
            --success: #10B981;
            --danger: #DC2626;
            --warning: #FBBF24;
            --bg-light: #F9FAFB;
            --text-dark: #212121;
            --text-muted: #6B7280;
            --border-color: #E5E7EB;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 2rem;
            border-radius: 15px 15px 0 0;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .header p {
            opacity: 0.9;
        }
        
        .form-container {
            background: white;
            padding: 2rem;
            border-radius: 0 0 15px 15px;
            box-shadow: var(--shadow);
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .required {
            color: var(--danger);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
            font-family: inherit;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }
        
        .score-input {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
        }
        
        .info-box {
            background: #EFF6FF;
            border: 1px solid #3B82F6;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .warning-box {
            background: #FEF3C7;
            border: 1px solid var(--warning);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }
        
        button {
            flex: 1;
            padding: 1rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #e5e7eb;
            color: var(--text-dark);
        }
        
        .btn-secondary:hover {
            background: #d1d5db;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .success-message {
            background: #D1FAE5;
            border: 1px solid var(--success);
            color: #065F46;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            display: none;
        }
        
        .error-message {
            background: #FEE2E2;
            border: 1px solid var(--danger);
            color: #991B1B;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            display: none;
        }
        
        .range-scale {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-muted);
        }
        
        /* Escala de estado anímico sin emojis */
        .mood-scale {
            display: flex;
            justify-content: space-around;
            gap: 1rem;
            padding: 0.5rem 0;
        }
        
        .mood-scale input[type="radio"] {
            display: none;
        }
        
        .mood-scale label {
            flex: 1;
            text-align: center;
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.875rem;
        }
        
        .mood-scale label:hover {
            border-color: var(--primary);
            background: #f3f4f6;
        }
        
        .mood-scale input[type="radio"]:checked + label {
            border-color: var(--primary);
            background: #EFF6FF;
            font-weight: 600;
        }
        
        /* Grid de temas */
        .topics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 0.5rem;
            margin-top: 0.5rem;
            max-height: 300px;
            overflow-y: auto;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: #fafafa;
        }
        
        .topic-checkbox {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-radius: 6px;
            transition: background 0.2s;
        }
        
        .topic-checkbox:hover {
            background: white;
        }
        
        .topic-checkbox input[type="checkbox"] {
            width: auto;
            margin-right: 0.5rem;
        }
        
        .topic-checkbox label {
            margin: 0;
            font-weight: normal;
            font-size: 0.875rem;
            cursor: pointer;
        }
        
        /* Contador de caracteres */
        .char-counter {
            text-align: right;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }
        
        /* Separador de secciones */
        .section-divider {
            border-top: 2px solid var(--border-color);
            margin: 2rem -2rem 2rem;
            padding-top: 2rem;
            position: relative;
        }
        
        .section-title {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 0 1rem;
            color: var(--text-muted);
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Campos inline */
        .inline-group {
            display: flex;
            gap: 1rem;
        }
        
        .inline-group .form-group {
            flex: 1;
        }
        
        /* Helpers */
        .help-text {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }
        
        /* Checkbox mejorado */
        input[type="checkbox"] {
            width: auto;
            margin-right: 0.5rem;
            cursor: pointer;
        }
        
        @media (max-width: 640px) {
            .container {
                padding: 0;
            }
            
            .form-container {
                padding: 1.5rem;
            }
            
            .mood-scale {
                flex-direction: column;
            }
            
            .inline-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Enviar Resultados del Simulacro</h1>
            <p>IZETA 2025 - Sistema Avanzado de Seguimiento</p>
        </div>
        
        <div class="form-container">
            <div class="info-box">
                <strong>Importante:</strong> Solo puedes enviar un resultado por simulacro. 
                Los datos adicionales nos permiten personalizar tu preparación.
            </div>
            
            <form id="resultsForm">
                <!-- SECCIÓN 1: Identificación -->
                <div class="form-group">
                    <label for="email">
                        Email <span class="required">*</span>
                    </label>
                    <input 
                        type="email" 
                        id="email" 
                        name="email" 
                        required 
                        placeholder="tu@email.com"
                    >
                </div>
                
                <div class="form-group">
                    <label for="simulacro">
                        Simulacro RF <span class="required">*</span>
                    </label>
                    <select id="simulacro" name="simulacro" required>
                        <option value="">Selecciona el simulacro...</option>
                    </select>
                </div>
                
                <!-- SECCIÓN 2: Resultados principales -->
                <div class="section-divider">
                    <span class="section-title">Resultados del examen</span>
                </div>
                
                <div class="inline-group">
                    <div class="form-group">
                        <label for="score">
                            Puntuación obtenida <span class="required">*</span>
                        </label>
                        <input 
                            type="number" 
                            id="score" 
                            name="score" 
                            min="0" 
                            max="100" 
                            required 
                            class="score-input"
                            placeholder="85"
                        >
                    </div>
                    
                    <div class="form-group">
                        <label for="blank_answers">
                            Preguntas en blanco
                        </label>
                        <input 
                            type="number" 
                            id="blank_answers" 
                            name="blank_answers" 
                            min="0" 
                            max="100" 
                            value="0"
                            class="score-input"
                            style="font-size: 1.2rem;"
                        >
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="time">
                        Tiempo empleado (minutos)
                    </label>
                    <input 
                        type="number" 
                        id="time" 
                        name="time" 
                        min="1" 
                        max="180" 
                        placeholder="95"
                    >
                </div>
                
                <div class="form-group">
                    <label>
                        <input 
                            type="checkbox" 
                            id="is_saturday" 
                            name="is_saturday"
                        >
                        Participé en el simulacro EN DIRECTO del sábado
                    </label>
                </div>
                
                <!-- SECCIÓN 3: Estado mental -->
                <div class="section-divider">
                    <span class="section-title">Estado durante el examen</span>
                </div>
                
                <div class="form-group">
                    <label for="confidence">
                        Nivel de confianza percibido (0-100)
                    </label>
                    <input 
                        type="range" 
                        id="confidence" 
                        name="confidence" 
                        min="0" 
                        max="100" 
                        value="50"
                    >
                    <div class="range-scale">
                        <span>Muy inseguro</span>
                        <span id="confidenceValue">50%</span>
                        <span>Muy seguro</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Estado emocional durante el examen</label>
                    <div class="mood-scale">
                        <input type="radio" name="stress_level" value="0" id="stress0" checked>
                        <label for="stress0">
                            Tranquilo
                        </label>
                        
                        <input type="radio" name="stress_level" value="50" id="stress50">
                        <label for="stress50">
                            Normal
                        </label>
                        
                        <input type="radio" name="stress_level" value="100" id="stress100">
                        <label for="stress100">
                            Muy nervioso
                        </label>
                    </div>
                </div>
                
                <!-- SECCIÓN 4: Análisis post-examen -->
                <div class="section-divider">
                    <span class="section-title">Análisis y mejora</span>
                </div>
                
                <div class="form-group">
                    <label for="review_time">
                        Tiempo dedicado a revisar y analizar fallos (minutos)
                    </label>
                    <input 
                        type="range" 
                        id="review_time" 
                        name="review_time" 
                        min="0" 
                        max="120" 
                        value="30"
                    >
                    <div class="range-scale">
                        <span>No revisé</span>
                        <span id="reviewValue">30 min</span>
                        <span>2 horas</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Identifica hasta 3 temas donde necesitas más refuerzo:</label>
                    <div class="topics-grid" id="topicsGrid">
                        <!-- Se llenará dinámicamente con los 45 temas -->
                    </div>
                    <p class="help-text">
                        Máximo 3 temas. Te recomendaremos enfocar tu estudio en estas áreas.
                    </p>
                </div>
                
                <div class="form-group">
                    <label for="difficulty_note">
                        Observaciones sobre dificultades específicas (opcional)
                    </label>
                    <input 
                        type="text" 
                        id="difficulty_note" 
                        name="difficulty_note"
                        maxlength="100"
                        placeholder="Ej: Confusión entre plazos procesales del tema 21"
                    >
                    <div class="char-counter">
                        <span id="charCount">0</span>/100
                    </div>
                </div>
                
                <div class="warning-box">
                    <strong>Recordatorio:</strong> La honestidad en tus respuestas nos permite 
                    ofrecerte recomendaciones más precisas para mejorar tu rendimiento.
                </div>
                
                <div class="button-group">
                    <button type="button" class="btn-secondary" onclick="window.location.href='index.html'">
                        Cancelar
                    </button>
                    <button type="submit" class="btn-primary" id="submitBtn">
                        Enviar Resultados
                    </button>
                </div>
            </form>
            
            <div id="successMessage" class="success-message">
                <strong>Resultados enviados correctamente.</strong><br>
                Procesando tus datos para generar recomendaciones personalizadas...
            </div>
            
            <div id="errorMessage" class="error-message">
                <span id="errorText">Error al enviar los resultados</span>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/assets/js/config.js"></script>
    <script>
        // Lista oficial de 45 temas
        const TEMAS = [
            "T1: El Derecho - Concepto y jerarquía normativa",
            "T2: Constitución (I) - Estructura y valores",
            "T3: Constitución (II) - Corona, Cortes, Gobierno",
            "T4: Unión Europea - Historia e instituciones",
            "T5: AGE - Organización y funcionamiento",
            "T6: Funcionarios públicos - Adquisición y pérdida",
            "T7: Ministerio del Interior - Estructura",
            "T8: DG Policía - Funciones y escalas",
            "T9: LO 2/1986 FCSE - Principios",
            "T10: Extranjeros UE/EEE - Entrada y residencia",
            "T11: Régimen sancionador extranjería",
            "T12: Protección internacional y refugiados",
            "T13: Seguridad privada en España",
            "T14: LO 4/2015 Seguridad Ciudadana",
            "T15: Infraestructuras críticas y ciberseguridad",
            "T16: Derecho Penal - Principios generales",
            "T17: Delitos contra vida, integridad y libertad",
            "T18: Delitos patrimoniales y socioeconómicos",
            "T19: Delitos contra orden público y armas",
            "T20: Delitos informáticos y prueba digital",
            "T21: Proceso penal y habeas corpus",
            "T22: Estatuto de la víctima del delito",
            "T23: Igualdad y violencia de género",
            "T24: PRL - Conceptos básicos",
            "T25: PRL - Marco normativo",
            "T26: Protección de datos personales",
            "T27: Derechos Humanos y MNP",
            "T28: Globalización y antiglobalización",
            "T29: Actitudes y discriminación",
            "T30: Principios éticos y delitos de odio",
            "T31: Inmigración y cohesión social",
            "T32: Geografía humana y población",
            "T33: Seguridad pública y privada",
            "T34: Drogodependencias",
            "T35: Desarrollo sostenible",
            "T36: Gramática española",
            "T37: Ortografía española",
            "T38: Sistemas operativos",
            "T39: Redes informáticas",
            "T40: Inteligencia y OSINT",
            "T41: Ciberdelincuencia",
            "T42: Armas y balística",
            "T43: Vehículo prioritario",
            "T44: Seguridad en conducción",
            "T45: PRL en seguridad vial"
        ];
        
        // Cargar temas en el grid
        function loadTopics() {
            const grid = document.getElementById('topicsGrid');
            TEMAS.forEach((tema, index) => {
                const div = document.createElement('div');
                div.className = 'topic-checkbox';
                div.innerHTML = `
                    <input type="checkbox" id="topic${index}" name="weakest_topics" value="${tema}">
                    <label for="topic${index}">${tema}</label>
                `;
                grid.appendChild(div);
            });
            
            // Limitar a 3 selecciones
            const checkboxes = document.querySelectorAll('input[name="weakest_topics"]');
            checkboxes.forEach(cb => {
                cb.addEventListener('change', function() {
                    const checked = document.querySelectorAll('input[name="weakest_topics"]:checked');
                    if (checked.length >= 3) {
                        checkboxes.forEach(box => {
                            if (!box.checked) box.disabled = true;
                        });
                    } else {
                        checkboxes.forEach(box => {
                            box.disabled = false;
                        });
                    }
                });
            });
        }
        
        // Detectar tipo de dispositivo
        function getDeviceType() {
            const ua = navigator.userAgent;
            if (/tablet|ipad|playbook|silk/i.test(ua)) {
                return 'tablet';
            }
            if (/Mobile|iP(hone|od)|Android|BlackBerry|IEMobile|Kindle|Opera M(obi|ini)/.test(ua)) {
                return 'mobile';
            }
            return 'desktop';
        }
        
        // Actualizar valor de confianza
        document.getElementById('confidence').addEventListener('input', function(e) {
            document.getElementById('confidenceValue').textContent = e.target.value + '%';
        });
        
        // Actualizar valor de tiempo de revisión
        document.getElementById('review_time').addEventListener('input', function(e) {
            const value = e.target.value;
            let text = value + ' min';
            if (value >= 60) {
                const hours = Math.floor(value / 60);
                const mins = value % 60;
                text = hours + 'h ' + (mins > 0 ? mins + ' min' : '');
            }
            document.getElementById('reviewValue').textContent = text;
        });
        
        // Contador de caracteres
        document.getElementById('difficulty_note').addEventListener('input', function(e) {
            document.getElementById('charCount').textContent = e.target.value.length;
        });

        // Cargar simulacros disponibles
        async function loadSimulacros() {
            try {
                const { data, error } = await supabaseClient
                    .from('weekly_simulations')
                    .select('id, week_number, start_date, end_date')
                    .eq('status', 'active')
                    .order('week_number', { ascending: false });

                if (error) throw error;

                const select = document.getElementById('simulacro');
                select.innerHTML = '<option value="">Selecciona el simulacro...</option>';
                
                data.forEach(sim => {
                    const option = document.createElement('option');
                    option.value = sim.id;
                    option.textContent = `RF${sim.week_number} - Semana del ${formatDate(sim.start_date)}`;
                    select.appendChild(option);
                });

            } catch (error) {
                console.error('Error cargando simulacros:', error);
            }
        }

        // Enviar formulario
        document.getElementById('resultsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const successMsg = document.getElementById('successMessage');
            const errorMsg = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            
            // Deshabilitar botón
            submitBtn.disabled = true;
            submitBtn.textContent = 'Enviando...';
            
            // Ocultar mensajes previos
            successMsg.style.display = 'none';
            errorMsg.style.display = 'none';
            
            try {
                // Obtener temas seleccionados
                const selectedTopics = Array.from(document.querySelectorAll('input[name="weakest_topics"]:checked'))
                    .map(cb => cb.value);
                
                // Obtener datos del formulario
                const formData = {
                    email: document.getElementById('email').value,
                    simulation_id: document.getElementById('simulacro').value,
                    score: parseInt(document.getElementById('score').value),
                    blank_answers: parseInt(document.getElementById('blank_answers').value),
                    confidence_score: parseInt(document.getElementById('confidence').value),
                    time_taken: document.getElementById('time').value ? parseInt(document.getElementById('time').value) * 60 : null,
                    is_saturday_live: document.getElementById('is_saturday').checked,
                    device_type: getDeviceType(),
                    stress_level: parseInt(document.querySelector('input[name="stress_level"]:checked').value),
                    review_time: parseInt(document.getElementById('review_time').value),
                    weakest_topics: selectedTopics,
                    difficulty_note: document.getElementById('difficulty_note').value || null
                };

                // Verificar si el usuario existe
                const { data: userData, error: userError } = await supabaseClient
                    .from('users')
                    .select('id')
                    .eq('email', formData.email)
                    .single();

                if (userError || !userData) {
                    throw new Error('Email no registrado en el sistema');
                }

                // Verificar si ya envió resultados para este simulacro
                const { data: existingResult } = await supabaseClient
                    .from('user_results')
                    .select('id')
                    .eq('user_id', userData.id)
                    .eq('simulation_id', formData.simulation_id)
                    .single();

                if (existingResult) {
                    throw new Error('Ya has enviado resultados para este simulacro');
                }

                // Enviar resultados
                const { error: insertError } = await supabaseClient
                    .from('user_results')
                    .insert({
                        user_id: userData.id,
                        simulation_id: formData.simulation_id,
                        score: formData.score,
                        blank_answers: formData.blank_answers,
                        confidence_score: formData.confidence_score,
                        time_taken: formData.time_taken,
                        is_saturday_live: formData.is_saturday_live,
                        device_type: formData.device_type,
                        stress_level: formData.stress_level,
                        review_time: formData.review_time,
                        weakest_topics: formData.weakest_topics,
                        difficulty_note: formData.difficulty_note
                    });

                if (insertError) throw insertError;

                // Mostrar éxito
                successMsg.style.display = 'block';
                
                // Añadir mensajes específicos según los datos
                let additionalMsg = '';
                if (formData.blank_answers > 10) {
                    additionalMsg += '<br>• Detectamos varias respuestas en blanco. Considera revisar estrategias de gestión del tiempo.';
                }
                if (formData.stress_level > 75) {
                    additionalMsg += '<br>• Tu nivel de estrés fue elevado. Te recomendamos técnicas de relajación pre-examen.';
                }
                if (selectedTopics.length > 0) {
                    additionalMsg += '<br>• Enfoca tu estudio en: ' + selectedTopics.join(', ');
                }
                
                if (additionalMsg) {
                    successMsg.innerHTML += additionalMsg;
                }
                
                document.getElementById('resultsForm').reset();
                
                // Redirigir después de 5 segundos
                setTimeout(() => {
                    window.location.href = 'leaderboard.html';
                }, 5000);

            } catch (error) {
                console.error('Error:', error);
                errorText.textContent = error.message || 'Error al enviar los resultados';
                errorMsg.style.display = 'block';
                
                // Rehabilitar botón
                submitBtn.disabled = false;
                submitBtn.textContent = 'Enviar Resultados';
            }
        });

        // Función helper para formatear fechas
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric' 
            });
        }

        // Cargar al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            loadSimulacros();
            loadTopics();
        });
    </script>
</body>
</html>